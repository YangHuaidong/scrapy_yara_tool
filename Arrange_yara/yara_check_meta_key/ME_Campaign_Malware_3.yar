rule ME_Campaign_Malware_3 {
  meta:
    author = "Spider"
    comment = "None"
    date = "2018-02-07"
    description = "Detects malware from Middle Eastern campaign reported by Talos"
    family = "None"
    hacker = "None"
    hash1 = "15f5aaa71bfa3d62fd558a3e88dd5ba26f7638bf2ac653b8d6b8d54dc7e5926b"
    judge = "black"
    license = "https://creativecommons.org/licenses/by-nc/4.0/"
    reference = "http://blog.talosintelligence.com/2018/02/targeted-attacks-in-middle-east.html"
    threatname = "None"
    threattype = "None"
  strings:
    $x1 = "objWShell.Run \"powershell.exe -ExecutionPolicy Bypass -File \"\"%appdata%\"\"\\sys.ps1\", 0 " fullword ascii
    $x2 = "objFile.WriteLine \"New-Item -Path \"\"$ENV:APPDATA\\Microsoft\\Templates\"\" -ItemType Directory -Force }\" " fullword ascii
    $x3 = "objFile.WriteLine \"$path = \"\"$ENV:APPDATA\\Microsoft\\Templates\\Report.doc\"\"\" " fullword ascii
    $s4 = "File=appData & \"\\sys.ps1\"" fullword ascii
  condition:
    uint16(0) == 0x6553 and filesize < 400KB and 1 of them
}